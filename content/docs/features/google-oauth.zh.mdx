---
title: Google OAuth
description: 使用 OAuth 2.0 实现 Google 登录
---

# Google OAuth

允许用户使用他们的 Google 帐户登录。

## 设置

### 1. 创建 Google OAuth 凭据

1. 前往 [Google Cloud Console](https://console.cloud.google.com/)
2. 创建新项目或选择现有项目
3. 导航到“API 和服务”→“凭据”
4. 点击“创建凭据”→“OAuth 客户端 ID”
5. 选择“Web 应用程序”
6. 添加授权重定向 URI：
   - 开发环境: `http://localhost:3000/api/auth/callback/google`
   - 生产环境: `https://yoursite.com/api/auth/callback/google`

### 2. 配置环境变量

添加到您的 `.env.local`：

```bash
GOOGLE_CLIENT_ID=your_client_id.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=your_client_secret
```

### 3. 配置 Better Auth

此启动器中已配置 Google OAuth 提供程序。检查 `lib/auth.ts`：

```typescript
import { betterAuth } from 'better-auth';
import { prismaAdapter } from 'better-auth/adapters/prisma';
import { db } from '@/prisma';

export const auth = betterAuth({
  database: prismaAdapter(db, {
    provider: 'postgresql',
  }),
  socialProviders: {
    google: {
      clientId: process.env.GOOGLE_CLIENT_ID!,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
    },
  },
});
```

## 实现

### 登录按钮

```tsx
'use client';

import { authClient } from '@/lib/auth-client';
import { Button } from '@/components/ui/button';

export function GoogleSignInButton() {
  const handleSignIn = async () => {
    await authClient.signIn.social({
      provider: 'google',
      callbackURL: '/dashboard',
    });
  };

  return (
    <Button onClick={handleSignIn} variant="outline">
      <GoogleIcon className="mr-2 h-4 w-4" />
      使用 Google 继续
    </Button>
  );
}
```

### 带有 Google 的身份验证对话框

```tsx
import { AuthButton } from '@/components/auth/auth-button';

export function Header() {
  return (
    <header>
      <nav>
        <AuthButton />
      </nav>
    </header>
  );
}
```

现有的 `AuthButton` 组件已包含 Google OAuth：

```tsx
// components/auth/auth-button.tsx
'use client';

import { authClient } from '@/lib/auth-client';

export function AuthButton() {
  const { data: session } = useSession();

  if (session) {
    return <UserMenu user={session.user} />;
  }

  return (
    <Button onClick={() => authClient.signIn.social({ provider: 'google' })}>
      登录
    </Button>
  );
}
```

## 用户数据

Google 提供以下用户数据：

```typescript
interface GoogleUser {
  id: string;
  email: string;
  name: string;
  image: string;
  emailVerified: boolean;
}
```

## 处理登录回调

回调由 Better Auth 在 `/api/auth/callback/google` 自动处理。

### 自定义回调逻辑

```typescript
// lib/auth.ts
export const auth = betterAuth({
  // ... 其他配置
  callbacks: {
    async signIn({ user, account, profile }) {
      if (account.provider === 'google') {
        // Google 登录后的自定义逻辑
        console.log('用户通过 Google 登录:', user.email);

        // 示例：检查电子邮件域是否允许
        const allowedDomains = ['company.com'];
        const emailDomain = user.email.split('@')[1];

        if (!allowedDomains.includes(emailDomain)) {
          return false; // 拒绝登录
        }
      }

      return true;
    },
  },
});
```

## 范围

请求额外权限：

```typescript
await authClient.signIn.social({
  provider: 'google',
  callbackURL: '/dashboard',
  options: {
    scope: 'openid email profile https://www.googleapis.com/auth/calendar',
  },
});
```

常见的 Google 范围：
- `openid email profile` - 基本个人资料（默认）
- `https://www.googleapis.com/auth/calendar` - Google 日历
- `https://www.googleapis.com/auth/drive` - Google 云端硬盘
- `https://www.googleapis.com/auth/gmail.readonly` - Gmail 读取

## 链接现有账户

允许用户将 Google 链接到现有账户：

```tsx
'use client';

import { authClient } from '@/lib/auth-client';

export function LinkGoogleAccount() {
  const handleLink = async () => {
    await authClient.linkSocial({
      provider: 'google',
    });
  };

  return (
    <Button onClick={handleLink}>
      链接 Google 账户
    </Button>
  );
}
```

## 解除账户链接

```tsx
export function UnlinkGoogleAccount() {
  const handleUnlink = async () => {
    await authClient.unlinkSocial({
      provider: 'google',
    });
  };

  return (
    <Button onClick={handleUnlink} variant="destructive">
      解除 Google 链接
    </Button>
  );
}
```

## 错误处理

```tsx
const handleSignIn = async () => {
  try {
    await authClient.signIn.social({
      provider: 'google',
      callbackURL: '/dashboard',
    });
  } catch (error) {
    if (error.code === 'access_denied') {
      console.log('用户取消登录');
    } else {
      console.error('登录错误:', error);
    }
  }
};
```

## 测试

1. 使用不同的 Google 账户进行测试
2. 测试电子邮件验证流程
3. 测试没有个人资料图片的账户
4. 测试错误场景（取消登录）

## 生产环境检查清单

- [ ] 配置生产环境重定向 URI
- [ ] 启用 OAuth 同意屏幕
- [ ] 添加隐私政策 URL
- [ ] 添加服务条款 URL
- [ ] 验证域所有权
- [ ] 请求敏感范围的验证

## 故障排除

### 重定向 URI 不匹配

确保 Google Console 中的重定向 URI 完全匹配：
```
http://localhost:3000/api/auth/callback/google
```

### 无效客户端

检查 `GOOGLE_CLIENT_ID` 和 `GOOGLE_CLIENT_SECRET` 是否正确。

### 访问被拒绝

用户可能已取消登录或拒绝权限。

## 后续步骤

- 添加 [GitHub OAuth](/docs/features/oauth-github)
- 实施 [魔术链接](/docs/features/magic-links)
- 了解 [用户身份验证](/docs/tutorials/user-authentication)
