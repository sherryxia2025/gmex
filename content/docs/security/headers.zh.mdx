---
title: 安全头
description: 配置 HTTP 安全头
---

# 安全头

通过配置 HTTP 安全头保护您的应用。

## 为什么需要安全头？

安全头可以帮助防止：
- 跨站脚本（XSS）
- 点击劫持攻击
- MIME 类型嗅探
- 信息泄漏
- 中间人攻击

## Next.js 配置

在 `next.config.ts` 中配置安全头：

```typescript
// next.config.ts
import type { NextConfig } from 'next';

const nextConfig: NextConfig = {
  async headers() {
    return [
      {
        source: '/:path*',
        headers: [
          {
            key: 'X-DNS-Prefetch-Control',
            value: 'on',
          },
          {
            key: 'Strict-Transport-Security',
            value: 'max-age=63072000; includeSubDomains; preload',
          },
          {
            key: 'X-Frame-Options',
            value: 'SAMEORIGIN',
          },
          {
            key: 'X-Content-Type-Options',
            value: 'nosniff',
          },
          {
            key: 'X-XSS-Protection',
            value: '1; mode=block',
          },
          {
            key: 'Referrer-Policy',
            value: 'origin-when-cross-origin',
          },
          {
            key: 'Permissions-Policy',
            value: 'camera=(), microphone=(), geolocation=()'
          },
        ],
      },
    ];
  },
};

export default nextConfig;
```

## 内容安全策略

通过 CSP 防止 XSS 攻击：

```typescript
const ContentSecurityPolicy = `
  default-src 'self';
  script-src 'self' 'unsafe-eval' 'unsafe-inline' https://www.googletagmanager.com;
  style-src 'self' 'unsafe-inline';
  img-src 'self' blob: data: https:;
  font-src 'self' data:;
  object-src 'none';
  base-uri 'self';
  form-action 'self';
  frame-ancestors 'none';
  upgrade-insecure-requests;
`;

const nextConfig: NextConfig = {
  async headers() {
    return [
      {
        source: '/:path*',
        headers: [
          {
            key: 'Content-Security-Policy',
            value: ContentSecurityPolicy.replace(/\s{2,}/g, ' ').trim(),
          },
        ],
      },
    ];
  },
};
```

## 头解释

### 严格传输安全（HSTS）

强制浏览器使用 HTTPS：

```
Strict-Transport-Security: max-age=63072000; includeSubDomains; preload
```

- `max-age`: 记住的时间（2 年）
- `includeSubDomains`: 应用于所有子域
- `preload`: 包含在浏览器预加载列表中

### X-Frame-Options

防止点击劫持：

```
X-Frame-Options: SAMEORIGIN
```

选项：
- `DENY`: 永不允许框架
- `SAMEORIGIN`: 只允许同源框架
- `ALLOW-FROM uri`: 允许特定 URI

### X-Content-Type-Options

防止 MIME 类型嗅探：

```
X-Content-Type-Options: nosniff
```

### X-XSS-Protection

传统 XSS 保护：

```
X-XSS-Protection: 1; mode=block
```

### Referrer-Policy

控制引荐来源信息：

```
Referrer-Policy: origin-when-cross-origin
```

选项：
- `no-referrer`: 永不发送引荐来源
- `origin`: 仅发送源
- `origin-when-cross-origin`: 同源的完整 URL，跨源的源
- `strict-origin-when-cross-origin`: 最严格

### Permissions-Policy

控制浏览器功能：

```
Permissions-Policy: camera=(), microphone=(), geolocation=()
```

禁用未使用的功能以减少攻击面。

## CSP 指令

### default-src

其他指令的回退：

```
default-src 'self';
```

### script-src

控制 JavaScript 源：

```
script-src 'self' 'unsafe-inline' 'unsafe-eval' https://trusted.com;
```

**注意**：在生产环境中避免使用 `unsafe-inline` 和 `unsafe-eval`。

### style-src

控制 CSS 源：

```
style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
```

### img-src

控制图片源：

```
img-src 'self' data: https: blob:;
```

### connect-src

控制 fetch、XHR、WebSocket：

```
connect-src 'self' https://api.yourapp.com;
```

### font-src

控制字体源：

```
font-src 'self' https://fonts.gstatic.com;
```

## 带有 Nonce 的 CSP

对于具有 Next.js 内联脚本：

```tsx
// app/[locale]/layout.tsx
import { headers } from 'next/headers';
import Script from 'next/script';

export default async function RootLayout({ children }) {
  const nonce = headers().get('x-nonce');

  return (
    <html>
      <head>
        <Script
          id="inline-script"
          nonce={nonce}
          dangerouslySetInnerHTML={{
            __html: `console.log('Inline script with nonce');`,
          }}
        />
      </head>
      <body>{children}</body>
    </html>
  );
}
```

## 中间件头

在中间件中添加头：

```typescript
// middleware.ts
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';

export function middleware(request: NextRequest) {
  const response = NextResponse.next();

  response.headers.set('X-Custom-Header', 'value');
  response.headers.set(
    'Strict-Transport-Security',
    'max-age=63072000; includeSubDomains; preload'
  );

  return response;
}
```

## 测试头

### 使用 curl

```bash
curl -I https://yoursite.com
```

### 使用安全头扫描器

在以下网站检查您的头：
- [securityheaders.com](https://securityheaders.com)
- [Mozilla Observatory](https://observatory.mozilla.org)

### 使用浏览器开发工具

1. 打开开发工具（F12）
2. 转到网络选项卡
3. 重新加载页面
4. 点击主文档
5. 检查响应头

## CORS 头

为 API 路由配置 CORS：

```typescript
// app/api/public/route.ts
import { NextResponse } from 'next/server';

export async function GET(request: Request) {
  const data = { message: 'Public API' };

  return NextResponse.json(data, {
    headers: {
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
      'Access-Control-Allow-Headers': 'Content-Type, Authorization',
    },
  });
}

export async function OPTIONS(request: Request) {
  return new NextResponse(null, {
    status: 200,
    headers: {
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
      'Access-Control-Allow-Headers': 'Content-Type, Authorization',
      'Access-Control-Max-Age': '86400',
    },
  });
}
```

## 生产环境头

完整的生产环境配置：

```typescript
const securityHeaders = [
  {
    key: 'Strict-Transport-Security',
    value: 'max-age=63072000; includeSubDomains; preload',
  },
  {
    key: 'X-Frame-Options',
    value: 'SAMEORIGIN',
  },
  {
    key: 'X-Content-Type-Options',
    value: 'nosniff',
  },
  {
    key: 'X-XSS-Protection',
    value: '1; mode=block',
  },
  {
    key: 'Referrer-Policy',
    value: 'strict-origin-when-cross-origin',
  },
  {
    key: 'Permissions-Policy',
    value: 'camera=(), microphone=(), geolocation=(), interest-cohort=()',
  },
  {
    key: 'Content-Security-Policy',
    value: ContentSecurityPolicy.replace(/\s{2,}/g, ' ').trim(),
  },
];

const nextConfig: NextConfig = {
  async headers() {
    return [
      {
        source: '/:path*',
        headers: securityHeaders,
      },
    ];
  },
};
```

## 最佳实践

1. **启用 HSTS** 强制使用 HTTPS
2. **使用严格的 CSP** 防止 XSS 攻击
3. **禁用未使用的功能** 以减少攻击面
4. **彻底测试** 确保所有页面与头一起正常运作
5. **监控违规行为** 记录 CSP 违规
6. **定期更新** 确保头的最新更新
7. **使用 Nonce** 对于内联脚本而不是 `unsafe-inline`

## CSP 违规报告

报告 CSP 违规：

```typescript
const ContentSecurityPolicy = `
  default-src 'self';
  script-src 'self';
  report-uri /api/csp-report;
  report-to csp-endpoint;
`;
```

```typescript
// app/api/csp-report/route.ts
export async function POST(request: Request) {
  const report = await request.json();

  console.log('CSP Violation:', report);

  // 发送到错误跟踪服务
  // Sentry.captureMessage('CSP Violation', { extra: report });

  return new NextResponse(null, { status: 204 });
}
```

## 下一步

- 实施 [速率限制](/docs/security/rate-limiting)
- 添加 [输入验证](/docs/security/validation)
- 查看 [OWASP Top 10](https://owasp.org/www-project-top-ten/)

